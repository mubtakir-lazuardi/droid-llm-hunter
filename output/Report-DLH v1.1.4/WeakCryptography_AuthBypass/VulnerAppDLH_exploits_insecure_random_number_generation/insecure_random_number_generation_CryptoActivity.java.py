#!/usr/bin/env python3
import subprocess
import time
import re
import xml.etree.ElementTree as ET

def run_adb_cmd(cmd_list):
    """Run ADB command and return stdout"""
    try:
        result = subprocess.run(cmd_list, capture_output=True, text=True)
        return result.stdout.strip()
    except Exception as e:
        print(f"Error: {e}")
        return ""

def get_token_from_ui():
    """Extract token using uiautomator dump with DEBUG output"""
    try:
        # Dump UI hierarchy to XML
        subprocess.run(['adb', 'shell', 'uiautomator', 'dump', '/sdcard/window_dump.xml'], 
                      capture_output=True, check=True)
        
        # Pull XML
        subprocess.run(['adb', 'pull', '/sdcard/window_dump.xml', '.'], 
                      capture_output=True, check=True)
        
        # Parse XML
        tree = ET.parse('window_dump.xml')
        root = tree.getroot()
        
        found_texts = []
        token_text = None
        
        # Scan all nodes
        for node in root.iter('node'):
            text = node.get('text', '')
            if text:
                found_texts.append(text)
                if 'Session Token (Weak):' in text:
                    token_text = text
        
        if not token_text:
            print(f"[DEBUG] Visible Text on Screen: {found_texts}")
            
        return token_text
                
    except Exception as e:
        print(f"UI Dump Failed: {e}")
        return None

def main():
    print("=== Weakness: Insecure Random Number Generation (PoC) ===")
    
    # 1. Launch Activity only if not already top? No, relaunch ensures clean state.
    print("[*] Launching CryptoActivity...")
    run_adb_cmd(['adb', 'shell', 'am', 'start', '-n', 'com.dlh.vulnerapp/.CryptoActivity'])
    time.sleep(3)
    
    # 2. Click 'Generate Session Token'
    # Try logic: If fails, try fallback coordinates.
    
    for attempt in range(2):
        print(f"[*] Click Attempt {attempt+1}...")
        
        # Strategy A: Keyboard Nav
        # HOME ensures we are at top (Focus usually lands on 1st button VIP).
        # We need 2nd button (Token).
        # Sequence: HOME (VIP) -> TAB (Token) -> ENTER
        run_adb_cmd(['adb', 'shell', 'input', 'keyevent', '122']) # HOME
        time.sleep(0.5)
        run_adb_cmd(['adb', 'shell', 'input', 'keyevent', '61']) # TAB (Focus Token)
        time.sleep(0.2) 
        run_adb_cmd(['adb', 'shell', 'input', 'keyevent', '66']) # ENTER
        
        time.sleep(2)
    
        # 3. Extract Result
        print("[*] Extracting Token from Screen...")
        token_text = get_token_from_ui()
    
        if token_text:
            print(f"\n[+] SUCCESS! Found Element: '{token_text}'")
            # Parse the long value
            match = re.search(r'Token \(Weak\): (-?\d+)', token_text)
            if match:
                token_val = match.group(1)
                print(f"[+] EXTRACTED TOKEN: {token_val}")
                print("\n[Analysis]")
                print(f"The app generated the token: {token_val}")
                print("Source Code Analysis confirms: 'Random random = new Random();'")
                print("Vulnerability: The seed is based on System Time.")
                break
            else:
                print("[-] Matches text but could not parse number.")
        else:
            print("[-] Token text not found. Retrying click...")
            # If standard nav failed, try generic coordinate tap (Middle of screen usually hits button 2 or 3)
            if attempt == 0:
                 print("[*] Trying fallback tap at 540 600...")
                 run_adb_cmd(['adb', 'shell', 'input', 'tap', '540', '600'])
                 time.sleep(1)

if __name__ == "__main__":
    main()
